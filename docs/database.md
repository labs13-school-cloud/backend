# Database

## Table of Contents

- [Intro](#intro)
- [Overview](#overview)
  - [Diagram](#diagram)
  - [Resources](#resources)
    - [users](#users)
    - [services](#services)
    - [tokens](#tokens)
    - [classes](#classes)
    - [classes_volunteers](#classes_volunteers)
    - [training_series](#training_series)
    - [training_series_volunteers](#training_series_volunteers)
    - [messages](#messages)
    - [notifications](#notifications)
    - [responses](#responses)
- [Database Standards](#database-standards)
  - [Methods](#methods)
  - [Key Names](#key-names)
- [Local Database](#local-database)

## Intro

This document will describe the data model built out for the back end, including links to an interactive diagram, describe the standard model methods and key names used to access and manipulate data within the database as well, and information for setting up a local database with PostgreSQL.

## Overview

The data model was refactored into this current shape based on the needs of the app--note that there are no many-to-many relationships. Previously, the back end had been duplicating data in Notifications from other tables such as Messages and Team Members that already existed in those tables. With this current model there is no duplication of data properties, and since the existence of a Notification linking a specific Message (and therefore Training Series) and Team Member together was the only confirmation needed that a Team Member was "assigned" to that Training Series, the many-to-many table connecting the Team Members and Training Series was eliminated. All needed database info is therefore accessible by simply joining as many tables together as required, and then selecting the desired information from wherever it may exist. This structure is simpler to work with on the back end with minimal filtering on the front end thanks to Redux, and is much more scalable if more data fields would be required.

### Diagram

[Link](https://dbdiagram.io/d/5ceee8ff1f6a891a6a6582af) to interactive diagram of current database model.

Special note about [dbdiagram.io]: you can generate a FK>>>PK relationship by simply dragging and dropping from the desired Foreign Key to the desired Primary Key.

### Resources

Note that all Tables are all snake_case and plural so as to allow for hassle-free manipulation with UNIX-based systems, database, query syntax, and reduction of typos. All tables also have auto-generated id integer as Primary Key. Seeded data is hard-code for some resources and other resources generated by [fakeData.js](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/helpers/fakeData.js) using npm package faker, see the documentation [here](https://github.com/marak/Faker.js/)

#### users

The logged-in end user that performs all operations within the app's front end. Other resources will be retrieved based on the currently logged-in user's email having been set on res.locals during authentication, and will not be able to retrieve information in the database they did not create.

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L3-L11) and [schema validation](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/schemas.js#L5-L21)

| property           | type         | description                                               | required |
|--------------------|--------------|-----------------------------------------------------------|----------|
| name               | string       | full user name                                            | yes      |
| email              | string       | user email, used for authentication                       | yes      |
| stripe             | string       | Authenticated Stripe ID, if user has one                  | no       |
| role               | string       | Role of the user which defaults to "volunteer"            | no       |
| approved           | boolean      | Tracks if user is approved for volunteering for a class   | no       |
| donator            | boolean      | Tracks if the user has donated                            | no       |


#### services

Services available for messaging option, currently Twilio.

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L)

| property | type   | description                                                                                             | required |
|----------|--------|---------------------------------------------------------------------------------------------------------|----------|
| name     | string | name of services available for messaging Team Members, currently limited to twilio.                     | yes      |


#### tokens

Tokens stored either for oAuth authentication. Stored for a specific User.

[Migrations](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#30-49) and [schema validation](https://github.com/labs12-training-bot-2/labs12-training-bot-2-BE/blob/master/models/schemas.js#75-89)


| property      | type         | description                                                               | required |
|---------------|--------------|---------------------------------------------------------------------------|----------|
| expiration    | datetime     | when stored token will no longer be valid                                 | no       |
| auth_token    | string       | token given for oAuth authentication                                      | yes      |
| refresh_token | string       | provided by oAuth services if needed for obtaining a renewed access token | no       |
| service_id    | integer (FK) | points to services.id                                                     | yes      |
| user_id       | integer (FK) | points to users.id                                                        | yes      |


#### classes

Describes the Classes that the Volunteers will be able to volunteer for.

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L36-L43)

| property           | type         | description                                                                                                                    | required |
|--------------------|--------------|--------------------------------------------------------------------------------------------------------------------------------|----------|
| class_name         | string       | classes name                                                                                                                   | yes      |
| grade_level        | string       | classes grade level                                                                                                            | yes      |
| subject            | string       | classes subject that is taught                                                                                                 | no       |
| teacher_name       | string       | name of the teacher in the class                                                                                               | no       |
| number_of_students | integer      | number of the students attending in the class                                                                                  | no       |

#### classes_volunteers

Describes the tables that keeps track of which class a volunteer is a part of

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L44-L60)

| property           | type         | description                                                                                                                    | required |
|--------------------|--------------|--------------------------------------------------------------------------------------------------------------------------------|----------|
| volunteer_id       | integer      | points to user.id                                                                                                              | yes      |
| class_id           | integer      | points to classes.id                                                                                                           | yes      |

#### training_series

Describes the Training Series that any number of Messages with training content can be generated for--any Volunteer assigned to a given series can be sent these messages. The act of assigning a Volunteer to the series, including options as to which available messaging medium the communication should go through, is what generates the actual Notifications that are delivered to said Team Member. (Messaging not yet implemented along with notifications)

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L61-L72) and [schema validation](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/schemas.js#L44-L51)

| property | type         | description                       | required |
|----------|--------------|-----------------------------------|----------|
| title    | string       | title of training series          | yes      |
| subject  | string       | subject taught in training series | no       |
| user_id  | integer (FK) | points to users.id                | yes      |

#### training_series_volunteers

Describes the table that is used to keep track of which user is a part of which training series.

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L74-L91)

| property           | type         | description                               | required |
|--------------------|--------------|-------------------------------------------|----------|
| volunteer_id       | boolean      | points to the user.id                     | no       |
| finished           | integer (fk) | status if the training series is finished | yes      |
| training_series_id | integer (FK) | points to training_series.id              | yes      |


#### messages

User creates this content with a title and description of what the message is, optionally includes a URL link for content. Note that said link is not meant to be generated by the app, this would be the actual training content that end users would want their employees to receive messages about so they could complete training.

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L92-L104) and [schema validation](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/schemas.js#65-81)

| property           | type         | description                                                                                                                                                   | required |
|--------------------|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| subject            | string       | subject of message to be sent to team members assigned to training series                                                                                     | yes      |
| body               | string       | message content                                                                                                                                               | yes      |
| link               | string       | url string that links message recipient to training content (not created by app)                                                                              | no       |
| training_series_id | integer (FK) | points to Training Series the message was created for                                                                                                         | yes      |


#### notifications

Notifications are automatically generated when a Volunteer is assigned to a Training Series that has Messages. 

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L105-L138) and [schema validation](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/schemas.js#101-122)

| property       | type        | description                                                                                                                                              | required |
|----------------|-------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| send_date      | datetime    | calculated datetime for when notification will be sent based on when recipient is set to start the Training Series based on messages.days_from_start     | yes      |
| is_sent        | boolean     | denotes whether Notification has been successfully sent, defaults to false                                                                               | yes      |
| num_attempts   | integer     | how many times Notification has attempted to be sent--current max allowed is 6                                                                           | yes      |
| thread         | string      | unique thread relating to message history between recipient Team Member and Slack                                                                        | no       |
| message_id     | integer(FK) | points to message.id of Message this Notification was generated from                                                                                     | yes      |
| service_id     | integer(FK) | points to services.id to denote whether messaging medium is twilio or something else (other messaging platform not yet implemented)                      | yes      |
| recipient_id   | integer(FK) | points to user.id of the Volunteer the Notification is going to                                                                                          | yes      |


#### responses

The catalogued Response from a Team Member as a reply to the Notification they received from the specific service. This currently could be either an sms response from Twilio (twilio currently the only one planned to be added)

[Migrations](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/migrations/20190506173831_data_model_v2.js#L139-L153) and [schema validation](https://github.com/labs13-school-cloud/labs13-school-cloud-BE/blob/master/models/schemas.js#124-131)

| property        | type        | description                                                                                   | required |
|-----------------|-------------|-----------------------------------------------------------------------------------------------|----------|
| body            | string      | contents of response from Team Member to a successfully sent Notification, needs to be parsed | no       |
| notification_id | integer(FK) | points to notifications.id of Notification the Response is responding to                      | yes      |
| created_at      | timestamp   | timestamp of when Response was created, used to filter based on most recent                   | yes      |


## Database Standards

These sections describe the standards adhered when accessing the back end in the interest of making the code scalable, easy to work with once you know the codebase, integrate extra table resources, write extra endpoints to access those resources, or to audit any of the existing methods and endpoints.

### Methods

Originally almost all of the existing resources had anywhere between 5 and 10 database methods, many of which were superfluous. All resources now have 4 standardized methods to minimize confusion and simplify both bug-hunting and expansion of functionality. 

| method                   | description                                                                                                                                                                                                  |
|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| .find(filters)           | Can READ either a single resource or multiple resources based on the filter passed in. It is the controller's responsibility to chain .first() on the response if expecting retrieve only a single resource. |
| .add(resource)           | CREATES resource into the database, then performs chained .find() to retrieve the newly-created object by its ID with the shape we laid out instead of just the values existing for that resource.          |
| .update(filter, changes) | UPDATES specific resource in the database based on the filters passed in (usually its own ID) and the sent changes, then performs chained .find() to retrieve the updated resource.                          |
| .remove(filter)          | DELETES resource from the database based on filter (usually its own ID, but other fields are used). Returns default 0 or 1 if deletion failed or succeeded.                                                  |


### Key Names

Methods use a standardized abbreviations for methods that require filtering or joining onto other resource tables (resource AS abbreviation)

| resource                   | abbreviation |
|----------------------------|--------------|
| messages                   | m            |
| users                      | u            |
| training_series            | ts           |
| responses                  | r            |
| tokens                     | tk           |
| services                   | s            |
| training_series_volunteers | tsv          |
| classes                    | c            |
| classes_volunteers         | cv           |


 See documentation for [Knex.js](https://knexjs.org/#Builder-join) for further information on joins and the syntax used.

## Local Database

Local database setup will require installation of postgreSQL as a service on your local machine, and not just run in your IDE as a library. Different installation methods exist depending on your OS, check out the documentation on installing at [postgresql.org](https://www.postgresql.org/download/)